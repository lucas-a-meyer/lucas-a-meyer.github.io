<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lucas A. Meyer">
<meta name="dcterms.date" content="2018-08-23">

<title>Lucas A. Meyer - Yo, Stroop!</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="..//favicon-32x32.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/iconify-1.0.7/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-6KTZ853BN5"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-6KTZ853BN5', { 'anonymize_ip': true});
</script>
<script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false,
  "showHighlights": "always"
}
</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<!-- Clarity tracking code for https://meyerperin.com/ -->
<script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i+"?ref=bwt";
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "cjhrvqb66a");
</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Lucas A. Meyer - Yo, Stroop!">
<meta property="og:description" content="">
<meta property="og:site-name" content="Lucas A. Meyer">
<meta name="twitter:title" content="Lucas A. Meyer - Yo, Stroop!">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Lucas A. Meyer</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-articles" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Articles</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-articles">    
        <li>
    <a class="dropdown-item" href="../articles/midjourney.html" rel="" target="">
 <span class="dropdown-text">Getting Started with Midjourney</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/semantic_kernel.html" rel="" target="">
 <span class="dropdown-text">A Quick Tour of the Semantic Kernel</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/adhd.html" rel="" target="">
 <span class="dropdown-text">Do I Have ADHD? (Work In Progress)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/skv_py.html" rel="" target="">
 <span class="dropdown-text">Explaining memes and images with the Semantic Kernel and the OpenAI Vision API</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/badlands_ranch.html" rel="" target="">
 <span class="dropdown-text">Badlands Ranch Dog Food Review</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/remarkable2.html" rel="" target="">
 <span class="dropdown-text">My experience with the reMarkable 2</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-reviews" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Reviews</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-reviews">    
        <li>
    <a class="dropdown-item" href="../articles/remarkable2.html" rel="" target="">
 <span class="dropdown-text">My experience with the reMarkable 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/badlands_ranch.html" rel="" target="">
 <span class="dropdown-text">Badlands Ranch Dog Food Review</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../posts/2023-03-29-zotero.html" rel="" target="">
 <span class="dropdown-text">Zotero for Citation Management and Bibliography Creation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../posts/2022-09-15_newsguard.html" rel="" target="">
 <span class="dropdown-text">NewsGuard is free for Microsoft Edge users</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../posts/2022-06-28-farmers-dog.html" rel="" target="">
 <span class="dropdown-text">My review of the Farmer’s Dog food service</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../using_quarto/index.html" rel="" target="">
 <span class="menu-text">Using Quarto</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-github-repositories" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">GitHub Repositories</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-github-repositories">    
        <li>
    <a class="dropdown-item" href="https://github.com/lucas-a-meyer/sk-vision-py" rel="" target="">
 <span class="dropdown-text">OpenAI Vision API with the Semantic Kernel</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/lucas-a-meyer/pytly" rel="" target="">
 <span class="dropdown-text">Pytly: Python client for the T.LY link shortener</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://threads.net/@lucas_a_meyer" rel="" target="">
 <span class="menu-text"><iconify-icon inline="" icon="fa6-brands:threads"></iconify-icon></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/lucasameyer" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lucas-a-meyer" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://stackoverflow.com/users/1850561/lucas-a-meyer" rel="" target=""><i class="bi bi-stack-overflow" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Yo, Stroop!</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lucas A. Meyer </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 23, 2018</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p><a href="https://github.com/RealLucasMeyer/yostroop">YoStroop</a> is a bot that allows members of a slack channel to give rewards to each other, usually as a way of saying “thank you” for help and valuable contributions.</p>
<p>It was developed using Python, Azure Functions v2.0 and Cosmos DB.</p>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>One of the Data Science Slack channels I’m a member of tried several different tools to keep track of the valuable contributions of its members. Some of the tools that we used to to track contributions became quite expensive and we started looking for an alternative. Since most people in the channel can program in R and Python, I thought we might develop our own Slack bot. Developing a Slack Bot is really straightforward. You essentially need a HTTP server that will receive JSONs and call Web APIs. I wanted to create a Slack bot that was:</p>
<ol type="1">
<li>Written in a language that most Data Scientists are familiar with (e.g.&nbsp;Python or R)</li>
<li>Virtually free to run</li>
<li>Serverless</li>
<li>Based on very well known technologies (e.g., <code>pyodbc</code> for databases)</li>
<li>Easy to modify from GitHub with no hassle</li>
<li>Developed and maintained in any major platform: Windows, macOS or Linux</li>
</ol>
<p>I have failed to achieve almost all of the goals above, but maybe will achieve most in the near future.</p>
</section>
<section id="azure-functions-v2" class="level2">
<h2 class="anchored" data-anchor-id="azure-functions-v2">Azure Functions v2</h2>
<p>Microsoft recently released a <a href="https://github.com/Azure/azure-functions-python-worker">Python worker</a> for the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-versions">Azure Functions runtime v2</a>. As of this writing (2018-08-23), both Azure Functions v2 and the python worker are in “preview mode”. The Azure Functions v1 runtime supports development and hosting only in the portal or on Windows. The v2 runtime runs on .NET Core, and therefore can run on Windows, macOS and Linux. Microsoft provides a <a href="https://github.com/Azure/azure-functions-core-tools">set of tools</a> based on Node.JS and .NET Core that make it easy to develop in any platform. That takes care of objectives #1, #3 and #6. Although knocking off three objectives simply by selecting Azure Functions v2 sounded very promising to begin with, that’s as many objectives as I could achieve.</p>
<section id="linux-host" class="level3">
<h3 class="anchored" data-anchor-id="linux-host">Linux host</h3>
<p>Regardless of the platform you develop on, Python function apps need to be hosted on <a href="https://blogs.msdn.microsoft.com/appserviceteam/2017/11/15/functions-on-linux-preview/">Azure Functions on Linux</a>. Running on Linux has a couple downsides:</p>
<ol type="1">
<li><p>You have to access the Azure Portal using a <a href="https://ms.portal.azure.com/?websitesextension_pythonFunctions=true">secret code</a> to enable Azure to offer Linux hosts</p></li>
<li><p>As of this writing (2018-08-23), Linux hosts can only be dedicated. Azure Functions can normally run in two modes: “Consumption” and “Dedicated”. Consumption is virtually free, but the “dedicated” mode costs approximately $35 per month for the cheapest version. According to the <a href="https://github.com/Azure/azure-functions-python-worker/blob/dev/README.md">README</a> the “Consumption” mode is upcoming, and I have a small allowance due to my MSDN subscription, so I caved.</p></li>
</ol>
<p>And there goes objective #2. But it seems temporary, so we’re probably good.</p>
</section>
<section id="developing-a-slack-bot" class="level3">
<h3 class="anchored" data-anchor-id="developing-a-slack-bot">Developing a Slack Bot</h3>
<p>A Slack bot is essentially an HTTP server that will receive JSONs and perform actions through HTTP requests. Azure Functions have an HTTP Trigger template, so this takes care of most of the plumbing. I created a Slack app using the instructions <a href="https://api.slack.com/bot-users">here</a>. This bot subscribes to events, which are sent to an URL. I’ve created the HTTP Server that provides that URL using the instructions on <a href="https://github.com/Azure/azure-functions-python-worker/wiki/Create-Function-(CLI)">how to create a function using the command line interface</a>, and creating a <a href="https://github.com/Azure/azure-functions-python-worker/tree/dev/tests/http_functions">sample based on the HttpTrigger</a>.</p>
<p>Specifically, my Azure Function receives JSONs for each message, parses them to see if they have a <code>:stroopwafel:</code>, and if they do, parses the mentions (<span class="citation" data-cites="user">@user</span>) in the message. For each mention, we log a :stroopwafel: gift in a database, from which we can build reports at the end of a period.</p>
</section>
<section id="pyodbc" class="level3">
<h3 class="anchored" data-anchor-id="pyodbc">PyODBC</h3>
<p>The original idea was tha whenever a message mentioned a <code>:stroopwafel:</code>, the bot would use <code>pyodbc</code> to save the message in a database. Databases are usually not free, but Azure offers SQL Server for as low as $5 per month, and that seemed acceptable. The problem is that <code>pyodbc</code> does not have a linux wheel, and currently Azure Functions for Linux <a href="https://github.com/Azure/azure-functions-core-tools/issues/640">requires wheels</a>. There’s a way of compiling the package on the fly, but it currently has a bug. And I don’t know how long it will take to fix that bug.</p>
<p>I searched for alternatives to PyODBC, and the best alternative was to use <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/introduction">Cosmos DB</a>, since its Python package <code>pydocumentdb</code> has a wheel. The downside is that the cheapest Cosmos DB plan as of this writing costs $25. And now we’re far away from objective #2, and we’re also not doing great with objective #4. However, I found Cosmos DB a pleasure to use.</p>
</section>
<section id="github" class="level3">
<h3 class="anchored" data-anchor-id="github">GitHub</h3>
<p>Once I was done with my development, which <a href="https://github.com/Azure/azure-functions-core-tools">Azure Functions Core Tools</a> made really convenient by setting a local test server whenever I run <code>func host start</code>, I pushed <a href="https://github.com/RealLucasMeyer/yostroop">my repository to GitHub</a> and configured the Azure Function app to consume it using Continuous Deployment, which is something that you can set up in Azure with just a few clicks. However, <a href="https://github.com/Azure/azure-functions-core-tools/issues/640">it doesn’t yet work</a> (sad trombone). Luckily, deploying without GitHub is not that bad. Again, Azure Functions Core Tools provides a command-line interface utility that pushes your application to the server: <code>func azure functionapp publish &lt;app-name&gt;</code>, and you’re done in a couple of minutes. But I also don’t fulfill objective #5.</p>
</section>
</section>
<section id="verdict" class="level2">
<h2 class="anchored" data-anchor-id="verdict">Verdict</h2>
<p>Although I was so far unable to fulfill half of my initial objectives, it looks like I’ll get there soon. There’s something magical about Azure Functions. It does a lot of the hard work for you, and if you’re familiar with one of the many languages available, you can deploy your program to production really fast. I had never developed a Slack bot before, and I’ve started the bot during a sleepless night and finished it in an afternoon. All in, it took me less than two days of work to get an app to production. There are still some kinks to be worked out but Azure Functions v2 has already proved to be useful to me.</p>
<p>I wrote about Azure Functions before, specifically about <a href="https://meyerperin.com/post/installing-python-packages-in-azure-functions/">using Python in Azure Functions v1</a>. Azure Functions can be very useful for Data Scientists: it’s an easy way to deploy a model to production, perform scheduled maintenance, update datasets on a schedule, etc. With v2, Python became a first class player. I’m sure I’ll use it a lot.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>